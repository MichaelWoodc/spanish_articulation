<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Letter H</title>
  <style>

    :root {
      --bg: #0f172a; /* slate-900 */
      --panel: #111827; /* gray-900 */
      --muted: #6b7280; /* gray-500 */
      --text: #f8fafc; /* slate-50 */
      --accent: #22c55e; /* green-500 */
      --danger: #ef4444; /* red-500 */
      --brand: #6366f1; /* indigo-500 */
      --card: #1f2937; /* gray-800 */
      --soft: #e5e7eb; /* gray-200 */
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background: linear-gradient(135deg,#0f172a,#111827); color: var(--text); }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    header { text-align: center; padding: 24px 12px; }
    h1 { font-size: clamp(24px, 5vw, 42px); margin: 0 0 8px; }
    p.lead { color: var(--soft); font-size: clamp(14px, 2.8vw, 18px); margin: 0 auto; max-width: 70ch; }
    .card { background: var(--card); border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
    .card-inner { padding: 16px; }
    .grid { display: grid; gap: 12px; }
    .grid.two { grid-template-columns: 1fr; }
    .grid.three { grid-template-columns: 1fr; }
    @media (min-width: 720px) { .grid.two { grid-template-columns: 1fr 1fr; } .grid.three { grid-template-columns: repeat(3, 1fr); } }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 18px; border-radius: 12px; border: 0; font-weight: 700; cursor: pointer; background: var(--brand); color: white; transition: transform .05s ease, opacity .2s ease; }
    .btn:active { transform: translateY(1px) scale(0.99); }
    .btn.secondary { background: #0ea5e9; }
    .btn.ghost { background: transparent; border: 1px solid rgba(255,255,255,0.18); color: var(--text); }
    .btn.success { background: var(--accent); }
    .btn.danger { background: var(--danger); }
    .btn.block { width: 100%; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .center { text-align: center; }
    .muted { color: var(--muted); }
    .big { font-size: 18px; }
    .progress { width: 100%; height: 10px; background: rgba(255,255,255,0.1); border-radius: 999px; overflow: hidden; }
    .bar { height: 100%; width: 0; background: linear-gradient(90deg, #22c55e, #84cc16); transition: width .3s ease; }
    video { width: 100%; border-radius: 12px; background: #0b1220; border: 1px solid rgba(255,255,255,0.08); }
    .tag { display: inline-block; padding: 6px 10px; border-radius: 999px; font-size: 12px; letter-spacing: .02em; background: rgba(255,255,255,0.08); }
    .pill { display: inline-block; padding: 8px 12px; border-radius: 999px; background: rgba(99,102,241,.15); color: #e0e7ff; font-weight: 700; font-size: 13px; }
    .kbd { background: rgba(255,255,255,0.12); border-radius: 6px; padding: 2px 6px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .hidden { display: none !important; }
    .spacer { height: 10px; }
    footer { text-align:center; padding: 40px 12px; color: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
        <h1>Letter: H</h1>
    </header>

    <!-- STEP 0: Intro / Instructions -->
    <section id="step0" class="card">
      <div class="card-inner">
        <h2>Instructions</h2>
        <div class="grid two">
          <div>
            <p class="big">Today we are going to work on the sound that the letter H makes at the beginning or inside a word.</p>
            <ul>
              <li>Remember that H is silent in Spanish.</li>
              <li>Example: The letter H in <i>Herb</i> makes the same sound as the letter H in Spanish.</li>
              <li>You will watch four series of videos with correct (<b>EXAMPLE</b>) and incorrect (<b>COUNTEREXAMPLE</b>) pronunciations with front or side close-up view. You can replay them <b>unlimited</b> times.</li>
              <li>Then you will classify <b>20 videos</b> as <b>EXAMPLE</b> vs <b>COUNTEREXAMPLE</b>. Each video can be played <b>once</b> before answering.</li>
              <li>From this point onward, the researcher will only communicate in Spanish.</li>
            </ul>
          </div>

        </div>
        <div class="spacer"></div>
        <div class="row center">
          <button class="btn" id="startExamples">NEXT</button>
        </div>
      </div>
    </section>

    <!-- STEP 1: Four Example Series -->
    <section id="step1" class="card hidden">
      <div class="card-inner">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <h2 style="margin:0">Examples<span id="exSeriesIdx" class="tag">1 / 4</span></h2>
          <span class="muted">Listen, then press <b>NEXT</b>.</span>
        </div>
        <div class="spacer"></div>
        <div id="exSeriesBox" class="grid two"></div>
        <div class="spacer"></div>
        <div class="row center">
          <button class="btn ghost" id="prevSeries">Previous</button>
          <button class="btn" id="nextSeries">NEXT</button>
        </div>
      </div>
    </section>

    <!-- STEP 2: Categorize -->
    <section id="step2" class="card hidden">
      <div class="card-inner">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <h2 style="margin:0">Your Turn! Classification</h2>
          <div style="min-width:160px">
            <div class="progress"><div class="bar" id="catBar"></div></div>
            <div class="muted" style="font-size:12px; text-align:right"><span id="catIdx">1</span>/20</div>
          </div>
        </div>
        <p class="muted">You can play each video <b>only once</b> before choosing your answer.</p>
        <div id="catWord" class="pill" style="margin-bottom:8px; display:inline-block"></div>
        <video id="catVideo" playsinline preload="metadata"></video>
        <div class="row">
          <button class="btn secondary" id="playCat">▶ Play</button>
          <button class="btn success" id="btnCorrect">Correct</button>
          <button class="btn danger" id="btnIncorrect">Incorrect</button>
        </div>
        <p id="catFeedback" class="big center hidden"></p>
      </div>
    </section>

    <!-- STEP 3: Practice -->
    <section id="step3" class="card hidden">
      <div class="card-inner">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <h2 style="margin:0">Now you practice! <span class="tag">3 tries</span></h2>
          <div style="min-width:160px">
            <div class="progress"><div class="bar" id="pracBar"></div></div>
            <div class="muted" style="font-size:12px; text-align:right"><span id="pracIdx">1</span>/20</div>
          </div>
        </div>
        <p class="muted">You'll see the EXAMPLE once. Then record up to three attempts. If the researcher marks your production as correct, you will hear a “click”.</p>

        <div id="pracWord" class="pill" style="margin-bottom:8px; display:inline-block"></div>
        <video id="pracVideo" playsinline preload="metadata"></video>
        <div class="row">
          <button class="btn secondary" id="playPrac">▶ See EXAMPLE (1 time)</button>
        </div>
        <div class="spacer"></div>

        <div id="micBlock" class="card" style="background:#0b1220;">
          <div class="card-inner">
            <div class="row" style="justify-content:space-between; align-items:center;">
              <strong>Recording</strong>
              <span class="muted">Allow microphone. Works best from <b>http://localhost</b> or HTTPS.</span>
            </div>
            <div class="spacer"></div>
            <div class="row">
              <button class="btn" id="btnMic">Grant microphone</button>
              <button class="btn ghost" id="btnRec" disabled>● Record attempt</button>
              <button class="btn ghost" id="btnStop" disabled>■ Stop</button>
            </div>
            <div class="spacer"></div>
            <div class="row">
              <button class="btn success" id="btnMarkOk" disabled>Mark as correct (click)</button>
              <button class="btn danger" id="btnMarkNo" disabled>Not correct</button>
              <span class="muted" id="triesLeft"></span>
            </div>
            <div id="attemptsList" class="grid two" style="margin-top:10px"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- STEP 4: Timer -->
    <section id="step4" class="card hidden">
      <div class="card-inner center">
        <h2>1-minute Timer - Nonsense Words</h2>
        <p class="muted">When you're ready, press <b>Start</b>. Count your responses separately or with the counter.</p>
        <div class="spacer"></div>
        <div class="row center" style="justify-content:center">
          <button class="btn" id="timerStart">Start</button>
          <button class="btn ghost" id="timerStop" disabled>Stop</button>
          <button class="btn secondary" id="timerReset">Reset</button>
        </div>
        <h1 id="timerDisplay" style="font-variant-numeric: tabular-nums; font-size:64px; margin:18px 0 6px;">01:00.0</h1>
        <div class="row center" style="justify-content:center">
          <button class="btn success" id="countPlus">+1</button>
          <button class="btn danger" id="countMinus">-1</button>
        </div>
        <p class="big">Count: <b id="countVal">0</b></p>
        <div class="spacer"></div>
        <button class="btn" id="toEnd">NEXT</button>
      </div>
    </section>

    <!-- STEP 5: End -->
    <section id="step5" class="card hidden">
      <div class="card-inner center">
        <h2>This is all for the sound of the letter H.</h2>
        <p class="big">THANK YOU</p>
        <div class="spacer"></div>
        <button class="btn ghost" id="restart">Restart</button>
      </div>
    </section>
  </div>
<script>

// ------------------- Data / Sources -------------------
// (A) Four example series (free replay)
const EXAMPLE_SERIES = [
  { title: "Escucha - Hacer", ej: "h/1_hacer_front_eg.mp4", contra: "h/1_hacer_front_neg.mp4" },
//  { title: "Escucha - Historia", ej: "h/1_historia_front_eg.mp4", contra: "h/1_historia_front_neg.mp4" },
//  { title: "Escucha - Alcohol", ej: "h/1_alcohol_front_eg.mp4", contra: "h/1_alcohol_front_neg.mp4" },
//  { title: "Escucha - Adherí", ej: "h/1_adher_side_eg.mp4", contra: "h/1_adher_front_neg.mp4" },
];

// (B) Pool for 20-classification task (single play)
const WORD_POOL = [
  { word: "Azahar", eg: "h/1_azahar_front_eg.mp4", neg: "h/1_azahar_front_neg.mp4" },
  { word: "Exhalo", eg: "h/1_exhalo_front_eg.mp4", neg: "h/1_exhalo_front_neg.mp4" },
];

// (C) Practice list (20 items, see prompt order)
const PRACTICE_LIST = [
  { word: "Hacer", eg: "h/1_hacer_front_eg.mp4" },
  { word: "Hecho", eg: "h/1_hecho_front_eg.mp4" },
];


const PRAISE = [
  "Good Job!",
    "Correct",

];


// ------------------- Helpers -------------------
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
const sleep = (ms) => new Promise(r => setTimeout(r, ms));
function shuffle(arr){ const a=[...arr]; for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function playClick(){ try { const C = window.AudioContext || window.webkitAudioContext; const ctx = new C(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.type = 'square'; o.frequency.setValueAtTime(1200, ctx.currentTime); g.gain.setValueAtTime(0.2, ctx.currentTime); o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime + 0.07); } catch(e){} }
function showStep(n){ for(let i=0;i<=5;i++){ const s = $('#step'+i); if(!s) continue; s.classList.toggle('hidden', i!==n); } window.scrollTo({top:0, behavior:'smooth'}); }

// ------------------- Step 0 -> Step 1 -------------------
$('#startExamples').addEventListener('click',()=>{ buildExampleSeries(); showStep(1); });

// ------------------- Step 1: Four series -------------------
let exIdx = 0;
function buildExampleSeries(){ renderSeries(); }
function renderSeries(){
  $('#exSeriesIdx').textContent = `${exIdx+1} / ${EXAMPLE_SERIES.length}`;
  const slot = $('#exSeriesBox');
  slot.innerHTML = '';
  const item = EXAMPLE_SERIES[exIdx];
  const cards = [
    { label: 'Example', src: item.ej },
    { label: 'CounterExample', src: item.contra },
  ];
  cards.forEach(c=>{
    const wrap = document.createElement('div');
    wrap.className = 'card';
    wrap.innerHTML = `<div class="card-inner">
      <h3 style="margin:6px 0 10px">${item.title} - <span class="tag">${c.label}</span></h3>
      <video playsinline preload="metadata" src="${c.src}"></video>
      <div class="row" style="margin-top:8px"><button class="btn secondary">▶ Play</button></div>
    </div>`;
    const v = wrap.querySelector('video');
    wrap.querySelector('button').addEventListener('click',()=>{ v.currentTime = 0; v.play(); });
    slot.appendChild(wrap);
  });
  $('#prevSeries').disabled = (exIdx===0);
  $('#nextSeries').textContent = (exIdx===EXAMPLE_SERIES.length-1) ? 'NEXT' : 'Next';
}
$('#prevSeries').addEventListener('click',()=>{ if(exIdx>0){ exIdx--; renderSeries(); }});
$('#nextSeries').addEventListener('click',()=>{ if(exIdx<EXAMPLE_SERIES.length-1){ exIdx++; renderSeries(); } else { startCategorization(); showStep(2); }});

// ------------------- Step 2: Categorization -------------------
let catQueue = [];
let catIdx = 0;
let catScore = 0;
let playedOnce = false;
function startCategorization(){ catQueue = shuffle(buildCatItems()).slice(0,20); catIdx = 0; catScore = 0; renderCat(); }
function buildCatItems(){
  // Build an array of {word, src, truth: 'eg'|'neg'} choosing either eg or neg per word
  const out = [];
  WORD_POOL.forEach(w => {
    // push both versions to increase variety
    out.push({ word:w.word, src:w.eg, truth:'eg' });
    out.push({ word:w.word, src:w.neg, truth:'neg' });
  });
  return out;
}
function renderCat(){
  const item = catQueue[catIdx];
  $('#catIdx').textContent = (catIdx+1);
  $('#catBar').style.width = `${((catIdx)/20)*100}%`;
  $('#catWord').textContent = item.word;
  const v = $('#catVideo'); v.src = item.src; v.currentTime = 0; v.pause();
  playedOnce = false;
  $('#catFeedback').classList.add('hidden');
  $('#playCat').disabled = false; $('#btnCorrect').disabled = true; $('#btnIncorrect').disabled = true;
}
$('#playCat').addEventListener('click',()=>{
  if(playedOnce) return; // enforce single play
  const v = $('#catVideo'); v.currentTime = 0; v.play(); playedOnce = true; $('#playCat').disabled = true; $('#btnCorrect').disabled = false; $('#btnIncorrect').disabled = false;
});
function checkCat(answer){
  const item = catQueue[catIdx];
  const correct = (answer === item.truth);
  const fb = $('#catFeedback');
  if(correct){ catScore++; fb.textContent = PRAISE[Math.floor(Math.random()*PRAISE.length)]; }
  else { fb.textContent = 'Incorrect'; }
  fb.classList.remove('hidden');
  setTimeout(()=>{
    catIdx++;
    if(catIdx>=20) { startPractice(); showStep(3); } else { renderCat(); }
  }, 900);
}
$('#btnCorrect').addEventListener('click',()=>checkCat('eg'));
$('#btnIncorrect').addEventListener('click',()=>checkCat('neg'));

// ------------------- Step 3: Practice (3 attempts, with click) -------------------
let pracIdx = 0;
let micStream = null, mediaRec = null, recChunks = [], tries = 0;
function startPractice(){ pracIdx = 0; renderPractice(); }
function renderPractice(){
  const item = PRACTICE_LIST[pracIdx];
  $('#pracIdx').textContent = (pracIdx+1);
  $('#pracBar').style.width = `${(pracIdx/20)*100}%`;
  $('#pracWord').textContent = item.word;
  const v = $('#pracVideo'); v.src = item.eg; v.currentTime = 0; v.pause();
  $('#playPrac').disabled = false; $('#playPrac').textContent = '▶ Ver Example (1 vez)';
  tries = 0; updateTries();
  $('#btnRec').disabled = !micStream; $('#btnStop').disabled = true; $('#btnMarkOk').disabled = true; $('#btnMarkNo').disabled = true;
  $('#attemptsList').innerHTML = '';
}
$('#playPrac').addEventListener('click',()=>{ const v=$('#pracVideo'); v.currentTime=0; v.play(); $('#playPrac').disabled=true; $('#playPrac').textContent='Example reproducido'; });
function updateTries(){ $('#triesLeft').textContent = `Intentos restantes: ${Math.max(0, 3-tries)}`; }
$('#btnMic').addEventListener('click', async ()=>{
  try{ micStream = await navigator.mediaDevices.getUserMedia({audio:true}); $('#btnMic').textContent='Micrófono listo'; $('#btnRec').disabled=false; }catch(e){ alert('No se pudo acceder al micrófono.'); }
});
$('#btnRec').addEventListener('click',()=>{
  if(!micStream) return; recChunks=[]; mediaRec = new MediaRecorder(micStream); mediaRec.ondataavailable = e => recChunks.push(e.data);
  mediaRec.onstop = ()=>{
    const blob = new Blob(recChunks, { type: 'audio/webm' });
    const url = URL.createObjectURL(blob);
    const item = document.createElement('div'); item.className='card';
    item.innerHTML = `<div class="card-inner"><strong>Intento ${tries}</strong><audio controls src="${url}"></audio></div>`;
    $('#attemptsList').appendChild(item);
    $('#btnMarkOk').disabled = false; $('#btnMarkNo').disabled = false;
  };
  mediaRec.start(); $('#btnRec').disabled=true; $('#btnStop').disabled=false;
});
$('#btnStop').addEventListener('click',()=>{ if(mediaRec && mediaRec.state!=='inactive'){ mediaRec.stop(); $('#btnStop').disabled=true; }});
$('#btnMarkOk').addEventListener('click',()=>{ playClick(); advancePractice(); });
$('#btnMarkNo').addEventListener('click',()=>{ advancePractice(); });
function advancePractice(){
  tries++;
  updateTries();
  $('#btnMarkOk').disabled=true; $('#btnMarkNo').disabled=true; $('#btnRec').disabled=false;
  if(tries>=3){
    setTimeout(()=>{
      pracIdx++;
      if(pracIdx>=20){ showStep(4); } else { renderPractice(); }
    }, 300);
  }
}

// ------------------- Step 4: Timer -------------------
let timer=null, tLeft=60_000;
function renderTimer(){ const s=Math.floor(tLeft/1000); const ms=Math.floor((tLeft%1000)/100); const mm=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); $('#timerDisplay').textContent = `${mm}:${ss}.${ms}`; }
renderTimer();
$('#timerStart').addEventListener('click',()=>{
  if(timer) return; const start = performance.now(); const end = start + tLeft;
  $('#timerStart').disabled=true; $('#timerStop').disabled=false;
  timer = setInterval(()=>{ const now=performance.now(); tLeft = Math.max(0, end - now); renderTimer(); if(tLeft<=0){ clearInterval(timer); timer=null; $('#timerStart').disabled=false; $('#timerStop').disabled=true; playClick(); } }, 50);
});
$('#timerStop').addEventListener('click',()=>{ if(!timer) return; clearInterval(timer); timer=null; $('#timerStart').disabled=false; $('#timerStop').disabled=true; });
$('#timerReset').addEventListener('click',()=>{ if(timer){ clearInterval(timer); timer=null; } tLeft=60_000; renderTimer(); $('#timerStart').disabled=false; $('#timerStop').disabled=true; $('#countVal').textContent='0'; });
$('#countPlus').addEventListener('click',()=>{ const el=$('#countVal'); el.textContent = String(parseInt(el.textContent||'0',10)+1); playClick(); });
$('#countMinus').addEventListener('click',()=>{ const el=$('#countVal'); el.textContent = String(Math.max(0, parseInt(el.textContent||'0',10)-1)); });
$('#toEnd').addEventListener('click',()=> showStep(5));
$('#restart').addEventListener('click',()=>{ showStep(0); });
</script>
</body>
</html>